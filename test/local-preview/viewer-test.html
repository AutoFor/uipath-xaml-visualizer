<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UiPath XAML Viewer - Local Test</title>
    <link rel="stylesheet" href="../../dist/styles/main.css">
</head>
<body>
    <div id="app">
        <!-- ヘッダー -->
        <header class="viewer-header">
            <h1>UiPath XAML Visualizer - ローカルテスト</h1>
            <div class="header-actions">
                <button id="toggle-tree" class="btn">ツリー表示切替</button>
                <button id="toggle-view" class="btn">Raw XML</button>
                <button id="copy-debug" class="btn">デバッグ情報コピー</button>
            </div>
        </header>

        <!-- メインコンテナ -->
        <div class="viewer-container">
            <!-- サイドバー: ツリービュー -->
            <aside id="tree-view" class="tree-view">
                <!-- XAML File Selection (moved from test-controls) -->
                <div class="tree-header" style="background: #e3f2fd; padding: 12px;">
                    <label for="xaml-select" style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 14px;">Select XAML File:</label>
                    <select id="xaml-select" class="select" style="width: 100%; padding: 8px; font-size: 13px; margin-bottom: 8px; border: 1px solid #0078d4; border-radius: 4px;">
                        <option value="">-- Select File --</option>
                    </select>
                    <button id="load-btn" class="btn" style="width: 100%; padding: 8px; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">Load</button>
                </div>
                <div id="tree-content" class="tree-content">
                    <!-- ツリー構造がここに動的に生成される -->
                </div>
            </aside>

            <!-- メインビュー -->
            <main class="main-view">
                <div id="visual-view" class="visual-view">
                    <div style="text-align: center; padding: 48px; color: #666;">
                        <h2>Select XAML File</h2>
                        <p>Choose a XAML file from the control panel and click Load button.</p>
                    </div>
                </div>
                <div id="raw-view" class="raw-view" style="display: none;">
                    <pre><code id="raw-xml"></code></pre>
                </div>
            </main>

            <!-- 詳細パネル -->
            <aside id="detail-panel" class="detail-panel" style="display: none;">
                <div class="panel-header">
                    <h3>アクティビティ詳細</h3>
                    <button id="close-panel" class="btn-close">×</button>
                </div>
                <div id="detail-content" class="detail-content">
                    <!-- 詳細情報がここに表示される -->
                </div>
            </aside>
        </div>

        <!-- ローディング表示 -->
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>XAML を読み込み中...</p>
        </div>

        <!-- エラー表示 -->
        <div id="error" class="error" style="display: none;">
            <p id="error-message"></p>
        </div>

        <!-- コピー成功ステータス -->
        <div id="copy-status" style="display: none; position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 16px 24px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10000; font-size: 14px;">
            デバッグ情報をコピーしました
        </div>
    </div>

    <!-- ローカルテスト用のスクリプト -->
    <script src="test-viewer.js"></script>
    <script>
        // グローバル変数からクラスを取得
        const { XamlParser, SequenceRenderer, TreeViewRenderer } = XamlViewer;

        let currentXaml = '';
        let isVisualMode = true;
        const parser = new XamlParser();
        const sequenceRenderer = new SequenceRenderer();
        const treeRenderer = new TreeViewRenderer();

        // JSONからXAMLファイルリストを取得
        async function scanXamlFiles() {
            try {
                console.log('XAMLファイルをスキャン中...');
                const response = await fetch('projects/sample/files.json');

                if (!response.ok) {
                    throw new Error(`files.jsonの読み込みに失敗: ${response.status}`);
                }

                const data = await response.json();
                const xamlFiles = data.files.map(filename => ({
                    name: filename,
                    path: `projects/sample/${filename}`
                }));

                console.log('検出されたXAMLファイル:', xamlFiles);
                return xamlFiles;
            } catch (error) {
                console.error('XAMLファイルスキャンエラー:', error);
                return [];
            }
        }

        // ドロップダウンを動的に更新
        async function populateXamlSelect() {
            const select = document.getElementById('xaml-select');
            const xamlFiles = await scanXamlFiles();

            // 既存のオプションをクリア
            select.innerHTML = '<option value="">-- Select File --</option>';

            if (xamlFiles.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'Sample Project';

                let mainXamlPath = null; // Main.xamlのパスを保存

                xamlFiles.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.path;
                    option.textContent = file.name;
                    optgroup.appendChild(option);

                    console.log(`  - ${file.name} (${file.path})`); // 各ファイルをログ出力

                    // Main.xamlを見つけたらパスを保存
                    if (file.name === 'Main.xaml') {
                        mainXamlPath = file.path;
                        console.log('  → Main.xaml発見！');
                    }
                });

                select.appendChild(optgroup);
                console.log(`${xamlFiles.length}個のXAMLファイルを読み込みました`);

                // Main.xamlが存在すればデフォルト選択
                if (mainXamlPath) {
                    select.value = mainXamlPath;
                    console.log('✓ Main.xamlをデフォルト選択しました:', mainXamlPath);
                    console.log('  現在の選択値:', select.value);
                } else {
                    console.warn('⚠ Main.xamlが見つかりませんでした');
                }
            } else {
                console.warn('XAMLファイルが見つかりませんでした');
            }
        }

        // ローディング表示
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        // エラー表示
        function showError(message, error = null) {
            console.error('エラー発生:', message);
            if (error) {
                console.error('詳細:', error);
                console.error('スタックトレース:', error.stack);
            }

            const errorDiv = document.getElementById('error');
            const errorMessage = document.getElementById('error-message');

            let displayMessage = message;
            if (error) {
                displayMessage += '\n\n詳細: ' + error.toString();
                if (error.stack) {
                    displayMessage += '\n\nスタック:\n' + error.stack;
                }
            }

            errorMessage.textContent = displayMessage;
            errorMessage.style.whiteSpace = 'pre-wrap';
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 10000);
        }

        // XAMLファイルをパスから読み込み
        async function loadXamlFile(filePath) {
            try {
                console.log('ファイルパスから読み込み開始:', filePath);
                showLoading(true);

                console.log('fetch開始...');
                const response = await fetch(filePath);
                console.log('fetch完了 - ステータス:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`ファイルの読み込みに失敗しました: ${response.status} ${response.statusText}`);
                }

                console.log('テキスト読み込み開始...');
                const xamlText = await response.text();
                console.log('テキスト読み込み完了 - 長さ:', xamlText.length, '文字');

                currentXaml = xamlText;
                await renderXaml(xamlText);
                showLoading(false);
                console.log('読み込み成功！');
            } catch (error) {
                console.error('loadXamlFile エラー:', error);
                showError('ファイルパスからの読み込みエラー', error);
                showLoading(false);
            }
        }

        // ファイル選択から読み込み
        function loadXamlFromFile(file) {
            if (!file) {
                console.warn('ファイルが選択されていません');
                return;
            }

            console.log('ファイル選択から読み込み開始:', file.name, 'サイズ:', file.size, 'バイト');

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    console.log('FileReader読み込み完了');
                    showLoading(true);
                    const xamlText = e.target.result;
                    console.log('XAML読み込み完了 - 長さ:', xamlText.length, '文字');
                    console.log('XAML先頭100文字:', xamlText.substring(0, 100));

                    currentXaml = xamlText;
                    await renderXaml(xamlText);
                    showLoading(false);
                    console.log('レンダリング成功！');
                } catch (error) {
                    console.error('loadXamlFromFile エラー:', error);
                    showError('ファイル選択からの読み込みエラー', error);
                    showLoading(false);
                }
            };
            reader.onerror = (error) => {
                console.error('FileReader エラー:', error);
                showError('ファイルの読み込みに失敗しました', reader.error);
            };
            reader.readAsText(file);
        }

        // XAMLをレンダリング
        async function renderXaml(xaml) {
            try {
                console.log('レンダリング開始...');

                // パース
                console.log('XAML パース中...');
                const parsedData = parser.parse(xaml);
                console.log('パース成功:', parsedData);

                // ツリービューを生成
                console.log('ツリービュー生成中...');
                const treeContent = document.getElementById('tree-content');
                treeRenderer.render(parsedData, treeContent);
                console.log('ツリービュー完了');

                // メインビューを生成
                console.log('メインビュー生成中...');
                const visualView = document.getElementById('visual-view');
                sequenceRenderer.render(parsedData, visualView);
                console.log('メインビュー完了');

                // Raw XMLも準備
                console.log('Raw XML準備中...');
                const rawXml = document.getElementById('raw-xml');
                rawXml.textContent = xaml;
                console.log('Raw XML完了');

                console.log('レンダリング完了！');
            } catch (error) {
                console.error('renderXaml エラー:', error);
                showError('XAML解析エラー', error);
            }
        }

        // ビュー切替
        function toggleView() {
            isVisualMode = !isVisualMode;
            const visualView = document.getElementById('visual-view');
            const rawView = document.getElementById('raw-view');
            const toggleBtn = document.getElementById('toggle-view');

            if (isVisualMode) {
                visualView.style.display = 'block';
                rawView.style.display = 'none';
                toggleBtn.textContent = 'Raw XML';
            } else {
                visualView.style.display = 'none';
                rawView.style.display = 'block';
                toggleBtn.textContent = 'Visual View';
            }
        }

        // ツリー表示切替
        function toggleTreeView() {
            const treeView = document.getElementById('tree-view');
            treeView.classList.toggle('hidden');
        }

        // 詳細パネルを閉じる
        function closeDetailPanel() {
            document.getElementById('detail-panel').style.display = 'none';
        }

        // デバッグ情報をクリップボードにコピー
        async function copyDebugInfo() {
            try {
                // 選択されたファイル情報を取得
                const select = document.getElementById('xaml-select');
                const selectedFile = select.options[select.selectedIndex];
                const fileName = selectedFile ? selectedFile.textContent : 'Not Selected';
                const filePath = selectedFile ? selectedFile.value : 'N/A';

                // 表示エリアの内容を取得
                const visualView = document.getElementById('visual-view');
                const rawView = document.getElementById('raw-view');
                const treeContent = document.getElementById('tree-content');

                // 表示モードを確認
                const viewMode = isVisualMode ? 'Visual Mode' : 'Raw XML Mode';

                // パース済みデータを文字列化
                let parsedStructure = 'No XAML loaded';
                if (currentXaml) {
                    try {
                        const parsedData = parser.parse(currentXaml);
                        parsedStructure = JSON.stringify(parsedData, null, 2);
                    } catch (e) {
                        parsedStructure = 'Parse error: ' + e.message;
                    }
                }

                // 表示されているHTML内容を取得
                const renderedHTML = isVisualMode
                    ? visualView.innerHTML
                    : rawView.innerHTML;

                // デバッグ情報を整形
                const debugInfo = `=== XAML Visualizer Debug Info ===
File: ${fileName}
Path: ${filePath}
View Mode: ${viewMode}

[Parsed Structure]
${parsedStructure}

[Rendered HTML (selected area only)]
${renderedHTML}

[Tree View Content]
${treeContent.innerHTML}

[XAML Source (first 500 chars)]
${currentXaml ? currentXaml.substring(0, 500) + '...' : 'Not loaded'}
`;

                // クリップボードにコピー
                await navigator.clipboard.writeText(debugInfo);

                // コピー成功のフィードバック表示
                const statusDiv = document.getElementById('copy-status');
                statusDiv.style.display = 'block';
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 2000);

                console.log('デバッグ情報をクリップボードにコピーしました');
            } catch (error) {
                console.error('コピーエラー:', error);
                showError('クリップボードへのコピーに失敗しました', error);
            }
        }

        // イベントリスナー
        // Loadボタンをクリック
        document.getElementById('load-btn').addEventListener('click', () => {
            const select = document.getElementById('xaml-select');
            const filePath = select.value;
            if (filePath) {
                console.log('選択されたファイル:', filePath);
                loadXamlFile(filePath);
            } else {
                showError('XAMLファイルを選択してください');
            }
        });

        // セレクトボックスでEnterキー
        document.getElementById('xaml-select').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('load-btn').click();
            }
        });

        document.getElementById('toggle-view').addEventListener('click', toggleView);
        document.getElementById('toggle-tree').addEventListener('click', toggleTreeView);
        document.getElementById('close-panel').addEventListener('click', closeDetailPanel);
        document.getElementById('copy-debug').addEventListener('click', copyDebugInfo); // デバッグ情報コピーボタン

        // ページ読み込み時にXAMLファイルをスキャン
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('ページ読み込み完了 - XAMLファイルをスキャンします');
            await populateXamlSelect();
        });
    </script>
</body>
</html>
