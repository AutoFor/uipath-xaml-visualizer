# Feature Guide

各機能の使い方イメージと、表示される UI を整理する。

---

## 差分ビジュアライズ

PR の File Changes で「View as Workflow」をクリックすると、base と head の XAML を比較して差分をカード形式で表示する。

### 差分サマリー

パネル上部に追加・削除・変更の件数が表示される。

```
┌──────────┐ ┌──────────┐ ┌──────────┐
│ 追加   2 │ │ 削除   1 │ │ 変更   3 │
└──────────┘ └──────────┘ └──────────┘
```

### 差分カード

各アクティビティの変更がカード形式で表示される。色分けは以下の通り:

| 差分タイプ | バッジ | 背景色 | 意味 |
|-----------|--------|--------|------|
| 追加 | `+ 追加` | 緑系 | 新しく追加されたアクティビティ |
| 削除 | `- 削除` | 赤系 | 削除されたアクティビティ |
| 変更 | `~ 変更` | 黄系 | プロパティが変更されたアクティビティ |

### 変更されたプロパティの表示

変更カードには、変更前後の値が GitHub diff 風に表示される:

```
PropertyName:
- 旧い値
+ 新しい値
```

Assign アクティビティの場合は「左辺」「右辺」のラベル付きで表示される:

```
左辺 (To):
- oldVariable
+ newVariable

右辺 (Value):
- oldExpression
+ newExpression
```

### スクリーンショット差分

InformativeScreenshot が変更された場合、Before/After の画像比較が表示される。

---

## DisplayName 表示

各アクティビティカードのタイトルは以下の形式で表示される:

```
[Icon] Type: DisplayName  [Badge]  [L行番号]
```

例:
- `[=] Assign: 変数Aに値を設定  + 追加  L45-L48`
- `[?] If: 条件分岐チェック  ~ 変更  L120-L135`
- `[Seq] Sequence: メイン処理  - 削除  L200-L250`

### アイコン一覧

| アイコン | アクティビティタイプ |
|---------|-------------------|
| `[Seq]` | Sequence |
| `[Flow]` | Flowchart |
| `[=]` | Assign |
| `[?]` | If |
| `[Loop]` | While, ForEach |
| `[Click]` | Click |
| `[Type]` | TypeInto |
| `[Get]` | GetText |
| `[Log]` | LogMessage |
| `[Invoke]` | InvokeWorkflowFile |
| `[Try]` | TryCatch |
| `[Wait]` | Delay |
| `[Act]` | その他 |

### DisplayName 変更時の表示

DisplayName 自体が変更された場合、旧名と新名が `→` で繋がれて表示される:

```
[=] Assign: 旧い名前 → 新しい名前  ~ 変更
```

---

## 行番号バッジ

各カードのヘッダー右側に行番号バッジが表示される。

```
L45          ← 1行のアクティビティ
L45-L67      ← 複数行にまたがるアクティビティ
```

- ツールチップ: `XAML 45行目〜67行目`
- クリック可能: クリックで Raw XAML の該当行にジャンプ（[カーソル位置同期](#カーソル位置同期)）

### 行番号の対応先

| 差分タイプ | 行番号の参照先 |
|-----------|--------------|
| 追加 | head 側の XAML |
| 削除 | base 側の XAML |
| 変更 | head 側の XAML |

---

## カーソル位置同期

Visualizer パネルと GitHub の Raw XAML 表示を双方向で同期する。

### Visualizer → GitHub（行番号バッジクリック）

1. Visualizer カード上の行番号バッジ（`L45-L67`）をクリック
2. GitHub 側で該当行がオレンジ色にハイライトされ、自動スクロール
3. 2 秒後にハイライトが自動消去

### GitHub → Visualizer（行番号セルクリック）

1. Raw XAML の行番号セルをクリック
2. Visualizer 側で対応するアクティビティカードがハイライトされ、自動スクロール
3. 3 秒後にハイライトが自動消去

### Blob ページと Diff ページの違い

| | Blob ページ | Diff ページ |
|--|-----------|-----------|
| GitHub 行番号の取得方法 | `id="LC{行番号}"` | `td.blob-num[data-line-number]` |
| GitHub → Visualizer | `td[id="L{行番号}"]` のクリック | `td.blob-num` のクリック |
| Visualizer → GitHub | `document.getElementById("LC{行番号}")` | ファイルコンテナ内の `td.blob-num` を検索 |

---

## レビューコメント連携

PR の Visualizer 上でレビューコメントの閲覧と投稿ができる。

### コメントインジケーター

コメントが存在するアクティビティのカードヘッダーに `[Cmt: N]` バッジが表示される。クリックでコメントパネルを展開/折りたたみ。

```
[=] Assign: 変数A  ~ 変更  L45-L48  [Cmt: 2]  [+]
```

### コメント閲覧

コメントパネルを展開すると、各コメントが以下の形式で表示される:

```
┌───────────────────────────────────┐
│ 🖼 username  2025/1/15 14:30      │
│ このアクティビティの変更理由は？    │
└───────────────────────────────────┘
```

- アバター画像、ユーザー名、タイムスタンプ
- コメント本文

### コメント投稿

カードヘッダーの `[+]` ボタンをクリックすると、コメント入力フォームが開く。

```
┌───────────────────────────────────┐
│ コメントを入力...                   │
│                                   │
│                                   │
│              [Cancel] [Comment]   │
└───────────────────────────────────┘
```

- GitHub API 経由で PR レビューコメントとして投稿される
- コメントは head 側 XAML の該当行範囲に紐づく
- 投稿成功後、楽観的更新で即座にコメントリストに反映
- API 認証失敗時は GitHub DOM 内の CSRF トークンを使ったフォールバックあり

---

## DisplayName 検索

Visualizer パネルが開いているとき、**Ctrl+F**（Mac: Cmd+F）で検索バーにフォーカスが移る。

### 検索バー

```
┌──────────────────────────────────────────────┐
│ [DisplayName で検索...        ] 1/5件  ▲ ▼ ✕ │
└──────────────────────────────────────────────┘
```

### 動作

- **インクリメンタル検索**: 入力と同時に 250ms デバウンスで検索実行
- **一致カードのハイライト**: 一致したカードの DisplayName 内に `<mark>` ハイライト
- **非一致カードの淡色表示**: 一致しないカード（かつ一致カードの祖先でもない）は淡色表示
- **ナビゲーション**: Enter で次の一致へ、Shift+Enter で前の一致へ（循環）
- **クリア**: Escape で検索をリセット

### キーボードショートカット

| キー | 動作 |
|------|------|
| Ctrl+F / Cmd+F | 検索バーにフォーカス |
| Enter | 次の一致へ |
| Shift+Enter | 前の一致へ |
| Escape | 検索クリア & フォーカス解除 |

---

## Blob ページでの表示

個別の `.xaml` ファイルページ（GitHub の blob ページ）では、差分ではなくワークフローの構造をツリー形式で表示する。

- アクティビティの階層構造を維持
- 子要素がある場合は折りたたみ可能（▼/▶ ボタン）
- 主要プロパティ（To, Value, Condition, Selector, Message）を簡略表示
- カードクリックで詳細パネル表示
- 行番号バッジとカーソル同期も利用可能

[← Home に戻る](./Home.md)
