name: Deploy Dev to GitHub Pages

# dev/featureãƒ–ãƒ©ãƒ³ãƒã¸ã®pushæ™‚ã«é–‹ç™ºç”¨Pagesã¸è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
on:
  push:
    branches-ignore: [main, master] # æœ¬ç•ªãƒ–ãƒ©ãƒ³ãƒä»¥å¤–ã™ã¹ã¦
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: read # ãƒªãƒã‚¸ãƒˆãƒªã®èª­ã¿å–ã‚Šæ¨©é™
  pages: write # GitHub Pagesã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
  id-token: write # IDãƒˆãƒ¼ã‚¯ãƒ³ã®ç™ºè¡Œæ¨©é™

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡ï¼šé–‹ç™ºç”¨ã¯ dev-pages ã‚°ãƒ«ãƒ¼ãƒ—ã§ç®¡ç†
concurrency:
  group: "dev-pages"
  cancel-in-progress: true # æ–°ã—ã„ãƒ“ãƒ«ãƒ‰ãŒæ¥ãŸã‚‰å¤ã„ã‚‚ã®ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«

jobs:
  build:
    runs-on: ubuntu-latest # Ubuntuç’°å¢ƒã§å®Ÿè¡Œ
    steps:
      - name: Checkout # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Setup Node.js # Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Node.js 20ã‚’ä½¿ç”¨
          cache: 'npm' # npmã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–

      - name: Install dependencies # ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: Run tests with coverage # ãƒ†ã‚¹ãƒˆã¨ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’å®Ÿè¡Œ
        run: npm run test:coverage || echo "Tests skipped - no test:coverage script"

      - name: Build test viewer # ãƒ†ã‚¹ãƒˆç”¨ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ
        run: npm run build:test

      - name: Build production # æœ¬ç•ªç”¨ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ
        run: npm run build

      - name: Prepare GitHub Pages content # GitHub Pagesç”¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æº–å‚™
        run: |
          mkdir -p _site

          # ãƒ‡ãƒ¢ãƒšãƒ¼ã‚¸ã®é…ç½®
          if [ -d "test/local-preview" ]; then
            mkdir -p _site/demo
            cp -r test/local-preview/* _site/demo/
          fi

          # ã‚µãƒ³ãƒ—ãƒ«XAMLãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®
          if [ -d "test/projects" ]; then
            mkdir -p _site/demo/projects
            cp -r test/projects/* _site/demo/projects/
          fi

          # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã®é…ç½®
          if [ -d "coverage" ]; then
            cp -r coverage/ _site/coverage/
          fi

          # é–‹ç™ºç”¨ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®ä½œæˆï¼ˆãƒ–ãƒ©ãƒ³ãƒåã‚’è¡¨ç¤ºï¼‰
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ja">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>UiPath XAML Visualizer - Dev Preview</title>
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                max-width: 1200px;
                margin: 0 auto;
                padding: 40px 20px;
                background: #f5f5f5;
              }
              h1 {
                color: #333;
                border-bottom: 3px solid #4CAF50;
                padding-bottom: 10px;
              }
              .dev-notice {
                background: #fff3cd;
                border-left: 4px solid #ffc107;
                padding: 16px;
                margin: 20px 0;
                border-radius: 4px;
              }
              .dev-notice strong {
                color: #856404;
              }
              .branch-info {
                background: #e3f2fd;
                border-left: 4px solid #2196F3;
                padding: 16px;
                margin: 20px 0;
                border-radius: 4px;
                font-family: monospace;
              }
              .card {
                background: white;
                border-radius: 8px;
                padding: 24px;
                margin: 20px 0;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
              }
              .card h2 {
                margin-top: 0;
                color: #4CAF50;
              }
              .links {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 16px;
                margin-top: 16px;
              }
              .link-item {
                display: block;
                padding: 16px;
                background: #f8f9fa;
                border-radius: 6px;
                text-decoration: none;
                color: #333;
                transition: all 0.3s;
                border: 2px solid transparent;
              }
              .link-item:hover {
                background: #4CAF50;
                color: white;
                border-color: #4CAF50;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(76,175,80,0.2);
              }
              .link-item h3 {
                margin: 0 0 8px 0;
                font-size: 18px;
              }
              .link-item p {
                margin: 0;
                font-size: 14px;
                opacity: 0.8;
              }
              .footer {
                text-align: center;
                margin-top: 40px;
                padding-top: 20px;
                border-top: 1px solid #ddd;
                color: #666;
              }
            </style>
          </head>
          <body>
            <h1>ğŸš§ UiPath XAML Visualizer - é–‹ç™ºãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h1>

            <div class="dev-notice">
              <strong>âš ï¸ ã“ã‚Œã¯é–‹ç™ºç”¨ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã§ã™</strong><br>
              ã“ã®ãƒšãƒ¼ã‚¸ã¯é–‹ç™ºä¸­ã®ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰è‡ªå‹•çš„ã«ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>
              æœ¬ç•ªç’°å¢ƒã§ã¯ã‚ã‚Šã¾ã›ã‚“ã®ã§ã€å‹•ä½œãŒä¸å®‰å®šãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚
            </div>

            <div class="branch-info">
              <strong>ãƒ–ãƒ©ãƒ³ãƒ:</strong> ${{ github.ref_name }}<br>
              <strong>ã‚³ãƒŸãƒƒãƒˆ:</strong> ${{ github.sha }}<br>
              <strong>ãƒ“ãƒ«ãƒ‰æ—¥æ™‚:</strong> $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            </div>

            <div class="card">
              <h2>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦</h2>
              <p>UiPath XAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦–è¦šçš„ã«è¡¨ç¤ºã—ã€å·®åˆ†ã‚’ç¢ºèªã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚</p>
              <p>ã“ã®ãƒšãƒ¼ã‚¸ã¯é–‹ç™ºç”¨ã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ãŠã‚Šã€æœ€æ–°ã®é–‹ç™ºçŠ¶æ³ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
            </div>

            <div class="card">
              <h2>ğŸ“‘ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</h2>
              <div class="links">
                <a href="demo/viewer-test.html" class="link-item">
                  <h3>ğŸ“Š ãƒ‡ãƒ¢ãƒšãƒ¼ã‚¸</h3>
                  <p>XAMLãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ã®ãƒ‡ãƒ¢</p>
                </a>
                <a href="demo/diff-viewer-test.html" class="link-item">
                  <h3>ğŸ” å·®åˆ†è¡¨ç¤ºãƒ‡ãƒ¢</h3>
                  <p>XAMLå·®åˆ†ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã®ãƒ‡ãƒ¢</p>
                </a>
                <a href="coverage/" class="link-item">
                  <h3>ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ</h3>
                  <p>ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®ç¢ºèª</p>
                </a>
                <a href="https://github.com/AutoFor/uipath-xaml-visualizer" class="link-item">
                  <h3>ğŸ’» GitHubãƒªãƒã‚¸ãƒˆãƒª</h3>
                  <p>ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª</p>
                </a>
              </div>
            </div>

            <div class="footer">
              <p>Â© 2024 UiPath XAML Visualizer | é–‹ç™ºç”¨è‡ªå‹•ãƒ“ãƒ«ãƒ‰ by GitHub Actions</p>
            </div>
          </body>
          </html>
          EOF

      - name: Upload artifact # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

  deploy:
    environment:
      name: github-pages-dev # é–‹ç™ºç”¨ã®ç’°å¢ƒå
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest # Ubuntuç’°å¢ƒã§å®Ÿè¡Œ
    needs: build # buildã‚¸ãƒ§ãƒ–ã®å®Œäº†ã‚’å¾…ã¤
    steps:
      - name: Deploy to GitHub Pages # GitHub Pagesã¸ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deployment
        uses: actions/deploy-pages@v4